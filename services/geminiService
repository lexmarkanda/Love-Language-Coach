import { GoogleGenerativeAI, GenerativeModel, Part, Content } from '@google/generative-ai'; // <-- 修改這裡！
import { ScenarioData, AIResponseSchema } from '../types';

// 從環境變數獲取 API Key
const API_KEY = process.env.API_KEY || '';
if (!API_KEY) {
  console.error("API_KEY is not set in environment variables!");
  // 可以在這裡拋出錯誤或提供一個默認的錯誤響應
}

// 初始化 Gemini AI 客戶端
// 這裡使用 GoogleGenerativeAI 類，而不是 GoogleGenAI
const genAI = new GoogleGenerativeAI(API_KEY);

// 選擇模型 (使用最新的穩定版本，例如 gemini-1.5-flash 或 gemini-pro-flash)
// 注意：gemini-3-flash-preview 已經過時或可能無效
const model = genAI.getGenerativeModel({ model: "gemini-1.5-flash" }); // <-- 修改這裡！

export const generateReplyAndFeedback = async (
  scenario: ScenarioData,
  history: { role: 'user' | 'model', content: string }[],
  userMessage: string
): Promise<AIResponseSchema> => {

  // 定義回應的 JSON Schema
  const RESPONSE_SCHEMA = {
    type: "object", // 注意：Type.OBJECT 是舊 SDK 的寫法，現在直接用字符串 "object"
    properties: {
      girlfriendReply: {
        type: "string",
        description: "女友身分的自然回覆內容",
      },
      coachFeedback: {
        type: "object",
        properties: {
          score: { type: "integer", description: "1-5 分的評分" },
          comment: { type: "string", description: "對用戶回覆的簡短評論" },
          suggestion: { type: "string", description: "更好的浪漫表達建議" },
        },
        required: ["score", "comment", "suggestion"],
      },
    },
    required: ["girlfriendReply", "coachFeedback"],
  };

  const systemInstruction = `
    你是一位感情導師。目前的目標是幫助用戶（男性）練習如何對女友表達愛意。
    
    請以兩個身分同時運作：
    1. 女友：根據情境「${scenario.title}」做出感性的回覆。
    2. 導師：分析用戶的表達（是否太單調？），給予 1-5 分並提供一個更具體、更浪漫的改寫建議。
    
    目前的初始情境：${scenario.introMessage}
    情境重點：${scenario.description}
    確保回應嚴格遵守提供的 JSON 格式。
  `;

  try {
    // 將歷史消息轉換為 Gemini API 要求的格式
    const contents: Content[] = history.map(msg => ({
      role: msg.role === 'user' ? 'user' : 'model', // 確保角色名稱正確
      parts: [{ text: msg.content }]
    }));

    // 添加當前用戶消息
    contents.push({
      role: "user",
      parts: [{ text: userMessage }]
    });

    const result = await model.generateContent({ // 使用上面定義的 model 實例
      contents: contents,
      systemInstruction: { parts: [{ text: systemInstruction }] }, // System Instruction 現在這樣寫
      generationConfig: {
        responseMimeType: "application/json",
        responseSchema: RESPONSE_SCHEMA, // 直接傳遞 JSON Schema 對象
      }
    });

    const text = result.response.text(); // 獲取回應文本
    return JSON.parse(text || '{}') as AIResponseSchema;

  } catch (error) {
    console.error("Gemini API Error:", error);
    return {
      girlfriendReply: "親愛的，我現在有點累，晚點再聊好嗎？",
      coachFeedback: {
        score: 0,
        comment: "連線目前不穩定",
        suggestion: "請稍後再試一次。"
      }
    };
  }
};
